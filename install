#!/bin/bash
set -e

cat <<"EOF"
     __     __  ____ __      
 ___/ /__  / /_/ _(_) /__ ___
/ _  / _ \/ __/ _/ / / -_|_-<
\_,_/\___/\__/_//_/_/\__/___/
	    by @leonjza
	https://github.com/leonjza/dotfiles
EOF

declare -a REQUIRED=( "stow" )
declare -a OPTIONAL=( "zsh" "nvim" )
declare -a STOWABLES=( "tmux" "zsh" "nvim" "starship" "zim" )

###
function green() { command echo -e "$(tput setaf 2; tput bold)$*$(tput sgr0)"; }
function red() { command echo -e "$(tput setaf 1)$*$(tput sgr0)"; }
function yellow() { command echo -e "$(tput setaf 3)$*$(tput sgr0)"; }
function header() { echo; command echo -e "$(tput bold)==> $*$(tput sgr0)"; }
function status() {
    local label=$1
    shift

    case "$label" in
        OK) printf "%sOK%s %s\n" "$(tput setaf 2; tput bold)" "$(tput sgr0)" "$*" ;;
        SKIP) printf "%sSKIP%s %s\n" "$(tput setaf 3; tput bold)" "$(tput sgr0)" "$*" ;;
        FAIL) printf "%sFAIL%s %s\n" "$(tput setaf 1; tput bold)" "$(tput sgr0)" "$*" ;;
        INFO) printf "%sINFO%s %s\n" "$(tput bold)" "$(tput sgr0)" "$*" ;;
    esac
}
function fn_exists() { declare -F "$1" > /dev/null; }
OKAY=true
BACKUPDIR=$HOME/.config/dotfile-backups

header "Checking prerequisites"

# required tools
for c in "${REQUIRED[@]}"
do
	if ! command -v $c &> /dev/null
	then
		OKAY=false
		status FAIL "$c (required) not found"
	else
		status OK "$c (required)"
	fi
done

# optional tools
for c in "${OPTIONAL[@]}"
do
	if ! command -v $c &> /dev/null
	then
		status SKIP "$c (optional) not found"
	else
		status OK "$c (optional)"
	fi
done

if ! $OKAY
then
	status FAIL "Install the required prerequisites first"
	exit 1
fi

function f_usage() {
	header "Usage"
	echo "$0 <subcommand>"
	echo
	echo "Subcommands:"
    echo "  usage       echo this usage information"
    echo "  backup      back up existing configs before stowing"
    echo "  stow        stow configurations (aka, update symlinks)"
    echo "  unstow      remove symlinks (removing configs)"
}

function f_backup() {
    target=$1
    dry_run=${2:-false}

    mkdir -p "$BACKUPDIR"

    if [[ -e $target ]] # exists
    then
        if [[ ! -L $target ]] # and is not a symlink
        then
            local relpath=${target#"$HOME"/}
            local dest="$BACKUPDIR/$relpath"
            mkdir -p "$(dirname "$dest")"
            if [[ $dry_run == true ]]; then
                status INFO "Would back up $target -> $dest"
            else
                status OK "Backed up $target -> $dest"
                mv "$target" "$dest"
            fi
        fi
    fi
}

function f_backup_stow_targets() {
    local dry_run=${1:-false}
    header "Checking for existing configs to back up"

    for s in "${STOWABLES[@]}"
    do
        if [[ ! -d $s ]]; then
            continue
        fi

        local entry
        while IFS= read -r -d '' entry; do
            local base
            base=$(basename "$entry")

            if [[ $base == ".config" && -d $entry ]]; then
                local config_entry
                while IFS= read -r -d '' config_entry; do
                    f_backup "$HOME/.config/$(basename "$config_entry")" "$dry_run"
                done < <(find "$entry" -mindepth 1 -maxdepth 1 -print0)
                continue
            fi

            f_backup "$HOME/$base" "$dry_run"
        done < <(find "$s" -mindepth 1 -maxdepth 1 -print0)
    done
}

# funcs
function f_backup_cmd() {
    header "Backing up configurations"
    f_backup_stow_targets false
    status OK "Backup complete"
}

function f_stow() {
    local dry_run=false
    if [[ $1 == "--dry-run" ]]; then
        dry_run=true
    fi

    f_backup_stow_targets "$dry_run"
    if [[ $dry_run == true ]]; then
        header "Dry run complete"
        status INFO "No backups or stow performed"
        return
    fi
    header "Stowing configurations"

    for s in "${STOWABLES[@]}"
    do
        stow -t "$HOME/" --restow "$s"
        status OK "Stowed $s"
    done
    echo
    status OK "Stow complete"
}

function f_unstow() {
    header "Unstowing configurations"
    status INFO "Your old configs should be at $BACKUPDIR"

    for s in "${STOWABLES[@]}"
    do
        stow -t "$HOME/" --delete "$s"
        status OK "Unstowed $s"
    done
    echo
    status OK "Unstow complete"
}

# parse commandline arguments
subcommand=$1
case $subcommand in
    "" | "usage" | "-h" | "--help")
        f_usage
        ;;
    *)
        shift
        if ! fn_exists f_${subcommand}
        then
            status FAIL "'$subcommand' is not a known command."
            status INFO "See: $0 usage"
            exit 1
        fi
        f_${subcommand} $@
        ;;
esac
